name: Provision Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:
    inputs:
      destroy:
        description: 'Destroy infrastructure instead of creating it'
        required: false
        type: boolean
        default: false

jobs:
  terraform:
    name: Provision Infrastructure
    runs-on: ubuntu-latest
    env:
      # Sensitive variables passed as environment variables (not in terraform.tfvars)
      TF_VAR_hcloud_token: ${{ secrets.HETZNER_TOKEN }}
      TF_VAR_healthchecks_api_key: ${{ secrets.HEALTHCHECKS_API_KEY }}
      TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
      # Non-sensitive variable from repository context
      TF_VAR_github_repository: ${{ github.repository }}
    outputs:
      vps_host: ${{ steps.tf_output.outputs.vps_host }}
      healthcheck_ping_url: ${{ steps.tf_output.outputs.healthcheck_ping_url }}
      cloudflare_tunnel_token: ${{ steps.tf_output.outputs.cloudflare_tunnel_token }}
      custom_domain_url: ${{ steps.tf_output.outputs.custom_domain_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
          terraform_wrapper: false

      - name: Restore Terraform State
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          workflow: infrastructure.yml
          name: terraform-state
          path: infra/terraform/
          if_no_artifact_found: warn

      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init

      - name: Terraform Validate
        working-directory: infra/terraform
        run: terraform validate

      - name: Terraform Plan
        if: ${{ !inputs.destroy }}
        working-directory: infra/terraform
        run: terraform plan

      - name: Terraform Apply
        if: ${{ !inputs.destroy }}
        working-directory: infra/terraform
        run: terraform apply -auto-approve

      - name: Terraform Destroy
        if: ${{ inputs.destroy }}
        working-directory: infra/terraform
        run: terraform destroy -auto-approve

      - name: Extract Terraform Outputs
        if: ${{ !inputs.destroy }}
        id: tf_output
        working-directory: infra/terraform
        run: |
          VPS_HOST=$(terraform output -raw server_ip)
          HEALTHCHECK_URL=$(terraform output -raw healthcheck_ping_url)
          CLOUDFLARE_TOKEN=$(terraform output -raw cloudflare_tunnel_token)
          CUSTOM_DOMAIN=$(terraform output -raw custom_domain_url)

          echo "vps_host=$VPS_HOST" >> $GITHUB_OUTPUT
          echo "healthcheck_ping_url=$HEALTHCHECK_URL" >> $GITHUB_OUTPUT
          echo "cloudflare_tunnel_token=$CLOUDFLARE_TOKEN" >> $GITHUB_OUTPUT
          echo "custom_domain_url=$CUSTOM_DOMAIN" >> $GITHUB_OUTPUT

      - name: Save Terraform State
        if: ${{ !inputs.destroy && !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: infra/terraform/terraform.tfstate
          retention-days: 90
          overwrite: true

  verify:
    name: Verify VPS Setup
    needs: terraform
    if: ${{ !inputs.destroy }}
    runs-on: ubuntu-latest

    steps:
      - name: Wait for VPS to be ready
        run: |
          echo "Waiting for VPS to accept SSH connections..."
          VPS_HOST="${{ needs.terraform.outputs.vps_host }}"

          for i in {1..60}; do
            if nc -z -w5 $VPS_HOST 22; then
              echo "âœ… VPS is accepting SSH connections!"
              sleep 30  # Give cloud-init more time to complete
              exit 0
            fi
            echo "Attempt $i/60 - waiting for SSH on $VPS_HOST..."
            sleep 10
          done

          echo "âŒ Could not connect to VPS after 10 minutes"
          exit 1

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ needs.terraform.outputs.vps_host }} >> ~/.ssh/known_hosts

      - name: Wait for cloud-init to complete
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy@${{ needs.terraform.outputs.vps_host }} << 'EOF'
            echo "Waiting for cloud-init to complete..."

            MAX_WAIT=600
            ELAPSED=0
            while [ ! -f /opt/app/.cloud-init-complete ]; do
              if [ $ELAPSED -ge $MAX_WAIT ]; then
                echo "ERROR: cloud-init did not complete within ${MAX_WAIT}s"
                exit 1
              fi
              echo "  Still waiting... (${ELAPSED}s)"
              sleep 10
              ELAPSED=$((ELAPSED + 10))
            done

            echo "âœ… cloud-init complete!"
            docker --version
            docker compose version
          EOF

      - name: Display setup information
        run: |
          echo "### ðŸŽ‰ Infrastructure Provisioned!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # VPS Details
          echo "**VPS IP:** \`${{ needs.terraform.outputs.vps_host }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**SSH access:** \`ssh deploy@${{ needs.terraform.outputs.vps_host }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # What's installed
          echo "**What's installed:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker & Docker Compose" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Firewall configured (SSH, HTTP, HTTPS)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deploy user with SSH access" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Auto-configured outputs
          echo "**Auto-configured (extracted from Terraform state):**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ VPS_HOST" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ needs.terraform.outputs.healthcheck_ping_url }}" ]; then
            echo "- âœ“ HEALTHCHECK_PING_URL (monitoring enabled)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -n "${{ needs.terraform.outputs.cloudflare_tunnel_token }}" ]; then
            echo "- âœ“ CLOUDFLARE_TUNNEL_TOKEN (custom domain enabled)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ CUSTOM_DOMAIN_URL: \`${{ needs.terraform.outputs.custom_domain_url }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Database secrets (optional, manual)
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—„ï¸ Optional Database Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If using databases, add these secrets manually:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Settings â†’ Secrets â†’ Actions â†’ New repository secret**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generate with: \`openssl rand -base64 32\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`POSTGRES_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`MYSQL_ROOT_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`REDIS_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Then uncomment database services in \`deploy/docker-compose.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Next steps
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ needs.terraform.outputs.custom_domain_url }}" ]; then
            echo "1. Uncomment \`cloudflared\` service in \`deploy/docker-compose.yml\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Push to \`main\` branch to trigger deployment" >> $GITHUB_STEP_SUMMARY
            echo "3. Your app will be available at: ${{ needs.terraform.outputs.custom_domain_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "1. Push to \`main\` branch to trigger deployment" >> $GITHUB_STEP_SUMMARY
            echo "2. Your app will be available at: http://${{ needs.terraform.outputs.vps_host }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key