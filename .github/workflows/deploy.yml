name: Deploy to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'deploy/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to VPS
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download infrastructure outputs
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          workflow: infrastructure.yml
          name: terraform-state
          path: ./terraform-state
          if_no_artifact_found: warn

      - name: Extract Terraform outputs
        id: terraform_outputs
        run: |
          if [ -f ./terraform-state/terraform.tfstate ]; then
            VPS_HOST=$(jq -r '.outputs.server_ip.value' ./terraform-state/terraform.tfstate)
            CLOUDFLARE_TUNNEL_TOKEN=$(jq -r '.outputs.cloudflare_tunnel_token.value // ""' ./terraform-state/terraform.tfstate)
            HEALTHCHECK_URL=$(jq -r '.outputs.healthcheck_ping_url.value // ""' ./terraform-state/terraform.tfstate)
            CUSTOM_DOMAIN=$(jq -r '.outputs.custom_domain_url.value // ""' ./terraform-state/terraform.tfstate)

            echo "vps_host=${VPS_HOST}" >> $GITHUB_OUTPUT
            echo "cloudflare_tunnel_token=${CLOUDFLARE_TUNNEL_TOKEN}" >> $GITHUB_OUTPUT
            echo "healthcheck_url=${HEALTHCHECK_URL}" >> $GITHUB_OUTPUT
            echo "custom_domain_url=${CUSTOM_DOMAIN}" >> $GITHUB_OUTPUT
            echo "✓ Extracted outputs from Terraform state"
          else
            echo "⚠️ No Terraform state found, using secrets (fallback)"
            echo "vps_host=${{ secrets.VPS_HOST }}" >> $GITHUB_OUTPUT
            echo "cloudflare_tunnel_token=${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" >> $GITHUB_OUTPUT
            echo "healthcheck_url=${{ secrets.HEALTHCHECK_PING_URL }}" >> $GITHUB_OUTPUT
            echo "custom_domain_url=${{ secrets.CUSTOM_DOMAIN_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Verify Setup Complete
        run: |
          if [ -z "${{ steps.terraform_outputs.outputs.vps_host }}" ]; then
            echo "❌ ERROR: VPS not configured!"
            echo ""
            echo "This workflow requires initial setup to be completed first."
            echo ""
            echo "Please follow these steps:"
            echo "1. Go to Actions → Provision Infrastructure"
            echo "2. Run the setup workflow"
            echo "3. Wait for it to complete successfully"
            echo ""
            echo "After setup completes, this workflow will run automatically on future pushes."
            exit 1
          fi
          echo "✓ Setup verified - VPS_HOST configured"

      - name: Create GitHub Deployment
        id: deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: production
          environment-url: ${{ steps.terraform_outputs.outputs.custom_domain_url || format('http://{0}', steps.terraform_outputs.outputs.vps_host) }}
          ref: ${{ github.sha }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ steps.terraform_outputs.outputs.vps_host }} >> ~/.ssh/known_hosts

      - name: Copy deployment files to VPS
        run: |
          scp -i ~/.ssh/deploy_key deploy/docker-compose.yml deploy@${{ steps.terraform_outputs.outputs.vps_host }}:/opt/app/
          scp -i ~/.ssh/deploy_key deploy/update.sh deploy@${{ steps.terraform_outputs.outputs.vps_host }}:/opt/app/

          # Copy backup script if it exists
          if [ -f deploy/scripts/db-backup.sh ]; then
            ssh -i ~/.ssh/deploy_key deploy@${{ steps.terraform_outputs.outputs.vps_host }} 'mkdir -p /opt/app/scripts'
            scp -i ~/.ssh/deploy_key deploy/scripts/db-backup.sh deploy@${{ steps.terraform_outputs.outputs.vps_host }}:/opt/app/scripts/
            ssh -i ~/.ssh/deploy_key deploy@${{ steps.terraform_outputs.outputs.vps_host }} 'chmod +x /opt/app/scripts/db-backup.sh'
          fi

      - name: Generate environment configuration
        run: ./scripts/generate-env.sh
        env:
          # GitHub context
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          # Database secrets (from GitHub Secrets)
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          # Cloudflare (from Terraform outputs)
          CLOUDFLARE_TUNNEL_TOKEN: ${{ steps.terraform_outputs.outputs.cloudflare_tunnel_token }}

      - name: Copy environment to VPS
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no .env deploy@${{ steps.terraform_outputs.outputs.vps_host }}:/opt/app/.env

      - name: Deploy application
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy@${{ steps.terraform_outputs.outputs.vps_host }} \
            'cd /opt/app && chmod +x update.sh && ./update.sh'

      - name: Ping healthcheck
        if: success()
        env:
          HEALTHCHECK_URL: ${{ steps.terraform_outputs.outputs.healthcheck_url }}
        run: |
          if [ -n "$HEALTHCHECK_URL" ]; then
            curl -fsS --retry 3 "$HEALTHCHECK_URL" > /dev/null && echo "✓ healthchecks.io pinged"
          else
            echo "ℹ healthchecks.io monitoring disabled (no HEALTHCHECK_PING_URL configured)"
          fi

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key deploy@${{ steps.terraform_outputs.outputs.vps_host }} << 'EOF'
            cd /opt/app
            docker compose ps
            docker compose logs --tail=50 app
          EOF

      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          state: success
          environment-url: ${{ steps.terraform_outputs.outputs.custom_domain_url || format('http://{0}', steps.terraform_outputs.outputs.vps_host) }}

      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          state: failure

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
