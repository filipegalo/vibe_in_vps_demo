version: '3.8'

services:
  app:
    image: ghcr.io/${GITHUB_REPOSITORY}:latest
    container_name: app
    restart: unless-stopped
    ports:
      - "80:3000"
    environment:
      - NODE_ENV=production
      # [DB_ENV_START] - Auto-managed by setup wizard
      # - DATABASE_URL=postgresql://${POSTGRES_USER:-app}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-app}
      # - MYSQL_URL=mysql://${MYSQL_USER:-app}:${MYSQL_PASSWORD}@mysql:3306/${MYSQL_DATABASE:-app}
      # - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      # [DB_ENV_END]
    networks:
      - app-network
    # [DB_DEPENDS_START] - Auto-managed by setup wizard
    # depends_on:
      # postgres:
        # condition: service_healthy
      # mysql:
        # condition: service_healthy
      # redis:
    #     condition: service_healthy
    # [DB_DEPENDS_END]
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================
  # Optional Databases - Auto-managed by setup wizard
  # ==========================================

  # [POSTGRES_START]
  # postgres:
  #   image: postgres:16-alpine
  #   container_name: postgres
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_USER: ${POSTGRES_USER:-app}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  #     POSTGRES_DB: ${POSTGRES_DB:-app}
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   networks:
  #     - app-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-app}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 30s
  # [POSTGRES_END]

  # [MYSQL_START]
  # mysql:
  #   image: mysql:8.0
  #   container_name: mysql
  #   restart: unless-stopped
  #   environment:
  #     MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
  #     MYSQL_USER: ${MYSQL_USER:-app}
  #     MYSQL_PASSWORD: ${MYSQL_PASSWORD:-${MYSQL_ROOT_PASSWORD}}
  #     MYSQL_DATABASE: ${MYSQL_DATABASE:-app}
  #   volumes:
  #     - mysql-data:/var/lib/mysql
  #   networks:
  #     - app-network
  #   healthcheck:
  #     test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 30s
  # [MYSQL_END]

  # [REDIS_START]
  # redis:
  #   image: redis:7-alpine
  #   container_name: redis
  #   restart: unless-stopped
  #   command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
  #   volumes:
  #     - redis-data:/data
  #   networks:
  #     - app-network
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 10s
  # [REDIS_END]

  # ==========================================
  # Optional: Cloudflare Tunnel for Custom Domain + HTTPS
  # ==========================================
  # Uncomment this service to enable custom domain with automatic HTTPS.
  # Requires: CLOUDFLARE_TUNNEL_TOKEN secret configured in GitHub
  # See docs/SETUP.md for complete setup instructions
  # ==========================================
  #
  # [CLOUDFLARE_START]
  # cloudflared:
  #   image: cloudflare/cloudflared:latest
  #   container_name: cloudflared
  #   restart: unless-stopped
  #   command: tunnel --no-autoupdate run
  #   environment:
  #     - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
  #   depends_on:
  #     - app
  #   networks:
  #     - app-network
  # [CLOUDFLARE_END]

networks:
  app-network:
    driver: bridge

# [DB_VOLUMES_START] - Auto-managed by setup wizard
# volumes:
#   postgres-data:
#   mysql-data:
#   redis-data:
# [DB_VOLUMES_END]
